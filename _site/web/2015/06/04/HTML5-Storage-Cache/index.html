
<!DOCTYPE html>
<html>
  <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <title>LeftTree - HTML5 Storage & Cache</title>
      <meta name="viewport" content="width=device-width">

      <!-- atom & rss feed -->
      <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
      <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
  </head>
  <body>
    <div class="site">
      <div class="sidebar" id="sidebar">
        <div class="header">
          <h1 class="title"><a href="http://lefttree.github.io"><img id="logo" src="/assets/themes/xiang/images/newLogo.jpg"></a></h1>
          <span class="tagline">Xiang Li</span>
        </div>
        <hr>
        <!--<div class="posts">-->
          <!--<ul class="posts-list">-->
            <!---->
              <!--<li class="post-link">-->
                <!--<a class="post-title" href="/life/2015/10/22/the-7-habits">-->
                  <!--<span class="post-date">22 Oct 2015</span>-->
                  <!--高效能人士的7个习惯-->
                <!--</a>-->
              <!--</li>-->
            <!---->
              <!--<li class="post-link">-->
                <!--<a class="post-title" href="/javascript/2015/10/20/javascript-scope-closure">-->
                  <!--<span class="post-date">20 Oct 2015</span>-->
                  <!--Javascript Scope and Closures-->
                <!--</a>-->
              <!--</li>-->
            <!---->
              <!--<li class="post-link">-->
                <!--<a class="post-title" href="/tool/2015/10/09/chrome-extensions">-->
                  <!--<span class="post-date">09 Oct 2015</span>-->
                  <!--Chrome Extension 推荐-->
                <!--</a>-->
              <!--</li>-->
            <!---->
              <!--<li class="post-link">-->
                <!--<a class="post-title" href="/linux/2015/10/06/mount-remote-folder">-->
                  <!--<span class="post-date">06 Oct 2015</span>-->
                  <!--NFS Mount Remote Folder-->
                <!--</a>-->
              <!--</li>-->
            <!---->
              <!--<li class="post-link">-->
                <!--<a class="post-title" href="/web/2015/09/25/netease-music">-->
                  <!--<span class="post-date">25 Sep 2015</span>-->
                  <!--海外的用户正常听网易云音乐-->
                <!--</a>-->
              <!--</li>-->
            <!---->
              <!--<li class="post-link">-->
                <!--<a class="post-title" href="/reading/2015/08/24/%E4%B8%8D%E8%A6%81%E5%81%9A%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E5%99%A8">-->
                  <!--<span class="post-date">24 Aug 2015</span>-->
                  <!--不要做程序生成器-->
                <!--</a>-->
              <!--</li>-->
            <!---->
              <!--<li class="post-link">-->
                <!--<a class="post-title" href="/programming%20style/2015/08/20/Javascript-Style-Guide-Notes">-->
                  <!--<span class="post-date">20 Aug 2015</span>-->
                  <!--Javascript Style Guide Notes-->
                <!--</a>-->
              <!--</li>-->
            <!---->
              <!--<li class="post-link">-->
                <!--<a class="post-title" href="/python/2015/08/18/python-mutable-arguments">-->
                  <!--<span class="post-date">18 Aug 2015</span>-->
                  <!--Python Mutable Default Arguments-->
                <!--</a>-->
              <!--</li>-->
            <!---->
              <!--<li class="post-link">-->
                <!--<a class="post-title" href="/python/2015/08/13/python-dictionary-key">-->
                  <!--<span class="post-date">13 Aug 2015</span>-->
                  <!--Python Dictionary Key-->
                <!--</a>-->
              <!--</li>-->
            <!---->
              <!--<li class="post-link">-->
                <!--<a class="post-title" href="/python/2015/07/28/python-stack-queue">-->
                  <!--<span class="post-date">28 Jul 2015</span>-->
                  <!--Python stack and queue-->
                <!--</a>-->
              <!--</li>-->
            <!---->
              <!--<li class="post-link">-->
                <!--<a class="post-title" href="/web/2015/07/22/strict-mode">-->
                  <!--<span class="post-date">22 Jul 2015</span>-->
                  <!--About strict mode-->
                <!--</a>-->
              <!--</li>-->
            <!---->
              <!--<li class="post-link">-->
                <!--<a class="post-title" href="/javascript/2015/07/07/practical-patterns-for-creating-objects">-->
                  <!--<span class="post-date">07 Jul 2015</span>-->
                  <!--Practical patterns for createing objects-->
                <!--</a>-->
              <!--</li>-->
            <!---->
              <!--<li class="post-link">-->
                <!--<a class="post-title" href="/notes/2015/07/07/eloquent-js-notes">-->
                  <!--<span class="post-date">07 Jul 2015</span>-->
                  <!--Eloquent Javascript Notes-->
                <!--</a>-->
              <!--</li>-->
            <!---->
              <!--<li class="post-link">-->
                <!--<a class="post-title" href="/programming%20style/2015/06/18/git-workflow">-->
                  <!--<span class="post-date">18 Jun 2015</span>-->
                  <!--Git Workflow-->
                <!--</a>-->
              <!--</li>-->
            <!---->
              <!--<li class="post-link">-->
                <!--<a class="post-title" href="/frontend/2015/06/12/react-twoway-binding">-->
                  <!--<span class="post-date">12 Jun 2015</span>-->
                  <!--React Two-way Binding-->
                <!--</a>-->
              <!--</li>-->
            <!---->
              <!--<li class="post-link">-->
                <!--<a class="post-title" href="/frontend/2015/06/12/gulp-setup">-->
                  <!--<span class="post-date">12 Jun 2015</span>-->
                  <!--Gulp Setup-->
                <!--</a>-->
              <!--</li>-->
            <!---->
              <!--<li class="post-link">-->
                <!--<a class="post-title" href="/programming%20style/2015/06/07/git-commit-style">-->
                  <!--<span class="post-date">07 Jun 2015</span>-->
                  <!--Git commit style-->
                <!--</a>-->
              <!--</li>-->
            <!---->
              <!--<li class="post-link">-->
                <!--<a class="post-title" href="/web/2015/06/04/HTML5-Storage-Cache">-->
                  <!--<span class="post-date">04 Jun 2015</span>-->
                  <!--HTML5 Storage & Cache-->
                <!--</a>-->
              <!--</li>-->
            <!---->
              <!--<li class="post-link">-->
                <!--<a class="post-title" href="/programming%20style/2015/06/03/JS-Best-Practices">-->
                  <!--<span class="post-date">03 Jun 2015</span>-->
                  <!--Javascript Best Practices-->
                <!--</a>-->
              <!--</li>-->
            <!---->
              <!--<li class="post-link">-->
                <!--<a class="post-title" href="/web/2015/06/01/Javascript-theGoodParts">-->
                  <!--<span class="post-date">01 Jun 2015</span>-->
                  <!--Javascript Good Parts-->
                <!--</a>-->
              <!--</li>-->
            <!---->
          <!--</ul>-->
        <!--</div>-->
        <ul class="nav">
            
            
            


  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  



        </ul>
        <div class="footer">
          <span id="footer-links">
            <!--<a href="http://www.xiangli.me" class="footer-link">About</a> -->
            <!--<span class="separator">&bull;</span>-->
            <!--[><a href="" class="footer-link">Twitter</a> <span class="separator">&bull;</span><]-->
            <!--<a href="https://github.com/lefttree" class="footer-link">GitHub</a>-->
            <ul class="soc">
                <li><a class="soc-github" href="https://github.com/lefttree"></a></li>
                <li><a class="soc-facebook" href="https://www.facebook.com/xiang.li.3726"></a></li>
                <li><a class="soc-linkedin" href="https://www.linkedin.com/pub/xiang-li/47/639/77a"></a></li>
                <li><a class="soc-email1" href="mailto:bylixiang@gmail.com"></a></li>
                <li><a class="soc-rss soc-icon-last" href="http://lefttree.github.io/rss.xml"></a></li>
            </ul>
          </span>
        </div>
      </div>

        

<div class="content" id="home">
  <div id="sidebar-button">
    <img src="/assets/themes/xiang/images/sidebar-button.png">
  </div>
  <div id="post-info">
    <div id="cover-photo-container">
      <img id="cover-photo" src="/assets/themes/xiang/images/cover.jpg">
    </div>
    <div id="info-container">
      <h1 id="title">HTML5 Storage & Cache</h1>
      <span id="date">04 Jun 2015</span>
    </div>
  </div>

  <div class="post">
    <p><a href="http://slides.html5rocks.com/">HTML5 Rocks Slide</a>
<a href="diveintohtml5.info">Dive into HTML5</a></p>

<h3 id="offline/storage">Offline/Storage</h3>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// use localStorage for persistent storage</span>
<span class="c1">// use sessionStorage for per tab storage</span>
<span class="nx">saveButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="nx">area</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">());</span>
<span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
<span class="nx">textarea</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">);</span>
</code></pre></div>
<p>you can use Modernizr to detect support for HTML5 Storage.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="k">if</span> <span class="p">(</span><span class="nx">Modernizr</span><span class="p">.</span><span class="nx">localstorage</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// window.localStorage is available!</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="c1">// no native support for HTML5 storage :(</span>
  <span class="c1">// maybe try dojox.storage or a third-party solution</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<p>The data is actually stored as a string.</p>
</blockquote>

<p><code>setItem()</code> and <code>getItem()</code>
<code>removeItem()</code> and <code>clear()</code></p>

<p>Track when storage changes</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;storage&quot;</span><span class="p">,</span> <span class="nx">handle_storage</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">(</span><span class="s2">&quot;onstorage&quot;</span><span class="p">,</span> <span class="nx">handle_storage</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>
<p>“5 megabytes” is how much storage space each origin gets by default.</p>

<h3 id="web-sql-database">Web SQL Database</h3>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">openDatabase</span><span class="p">(</span><span class="s2">&quot;DBName&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span> <span class="c1">//5MB</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">tx</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">tx</span><span class="p">.</span><span class="nx">executeSql</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM test&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="nx">successCallback</span><span class="p">,</span> <span class="nx">errorCallback</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p>###IndexedDB</p>

<p>Act like a dictionary to me</p>

<blockquote>
<p>the example is not complete</p>
</blockquote>

<h3 id="application-cache">Application Cache</h3>

<p>The home page of the offline web application points to this list, called a manifest file, which is just a text file located elsewhere on the web server. 
A web browser that implements HTML5 offline applications will read the list of URLs from the manifest file, download the resources, cache them locally, and automatically keep the local copies up to date as they change. When the time comes that you try to access the web application without a network connection, your web browser will automatically switch over to the local copies instead.</p>

<p>An offline web application revolves around a cache manifest file. </p>

<p><code>
&lt;html manifest=&quot;cache.manifest&quot;&gt;
</code></p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nb">window</span><span class="p">.</span><span class="nx">applicationCache</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;updateready&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">applicationCache</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="nb">window</span><span class="p">.</span><span class="nx">applicationCache</span><span class="p">.</span><span class="nx">UPDATEREADY</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">applicationCache</span><span class="p">.</span><span class="nx">swapCache</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">confirm</span><span class="p">(</span><span class="s1">&#39;A new version of this site is available. Load it?&#39;</span><span class="p">))</span> <span class="p">{</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">CACHE MANIFEST
# version 1.0.0

CACHE:
/html5/src/logic.js
/html5/src/style.css
/html5/src/background.png

NETWORK:
*
</code></pre></div>
<p>Your cache manifest file can be located anywhere on your web server, but it must be served with the content type <strong>text/cache-manifest</strong>.</p>

<blockquote>
<p>Every page of your web application needs a manifest attribute that points to the cache manifest for the entire application.</p>
</blockquote>

<h4 id="manifest-file">manifest file</h4>

<p>Divided into three parts: the “explicit” section, the “fallback” section, and the “online whitelist” section. If no section headers, default in the &quot;explicit&quot; section</p>

<blockquote>
<p>If multipage, should list all HTML pages in the manifest file</p>
</blockquote>

<h5 id="network-sections">Network Sections</h5>
<div class="highlight"><pre><code class="language-text" data-lang="text">CACHE MANIFEST
NETWORK:
/tracking.cgi
CACHE:
/clock.css
/clock.js
/clock-face.jpg
</code></pre></div>
<p>NETWORK: the beginning of the &quot;online whitelist&quot; section, resources in this section are never cached and are not avaiable offline
CACHE: the beginning of the &quot;explicit&quot; section</p>

<h5 id="fallback-sections">Fallback Sections</h5>
<div class="highlight"><pre><code class="language-text" data-lang="text">CACHE MANIFEST
FALLBACK:
/ /offline.html
NETWORK:
*
</code></pre></div>
<blockquote>
<p>This is important. It means that you can have an offline web application that “lazily” adds pages as you visit them. You don’t need to list every single one of your HTML pages in your cache manifest.</p>
</blockquote>

<p>The single character (/) will match any page on your site, not just the home page. </p>

<p>If your browser doesn’t find the page in the appcache, instead of displaying an error message, it will display the page /offline.html</p>

<blockquote>
<p>Is this example complete? No. Wikipedia is more than HTML files. It uses common CSS, JavaScript, and images on each page. Each of these resources would need to be listed explicitly in the CACHE: section of the manifest file, in order for pages to display and behave properly offline.</p>
</blockquote>

<h5 id="window.applicationcache">window.applicationCache</h5>

<p>Events:
* downloading
* progress
* cached
* noupdate
* updateready
* error</p>

<h5 id="developing-&amp;-debugging">Developing &amp; Debugging</h5>

<p>how your browser checks whether a cache manifest file has changed. 
<strong>3-phase process</strong></p>

<ol>
<li>Via normal HTTP semantics, your browser will check whether the cache manifest has expired. 
Just like any other file being served over HTTP, your <strong>web server</strong> will typically include <strong>meta-information</strong> about the file in the HTTP response headers. Some of these HTTP headers (Expires and Cache-Control) tell your browser how it is allowed to cache the file without ever asking the server whether it has changed. </li>
<li>If the cache manifest has expired (according to its HTTP headers), then your browser will ask the server <strong>whether there is a new version, and if so, the browser will download it</strong>. To do this, your browser issues an HTTP request that includes that <strong>last-modified date</strong> of the cache manifest, which your web server included in the HTTP response headers the last time your browser downloaded the manifest file. If the web server determines that the manifest file hasn’t changed since that date, it will simply return a 304 (Not Modified) status. </li>
<li>If the web server thinks the manifest file has changed since that date, it will return an HTTP 200 (OK) status code, followed by the contents of the new file, along with new Cache-Control headers and a new last-modified date, so that steps 1 and 2 will work properly the next time. (HTTP is cool; web servers are always planning for the future. If your web server absolutely must send you a file, it does everything it can to ensure that it doesn’t need to send it twice for no reason.) <strong>Once it’s downloaded the new cache manifest file, your browser will check the contents against the copy it downloaded last time.</strong> If the contents of the cache manifest file are the same as they were last time, your browser won’t re-download any of the resources listed in the manifest.</li>
</ol>

<p><strong>Debug</strong>
Step 1:
So here’s one thing you should absolutely do: reconfigure your web server so that your cache manifest file is not cacheable by HTTP semantics.</p>

<blockquote>
<p>you should either qualify this with a <Files> directive so it only affects your cache manifest file, or create a subdirectory that contains nothing but this .htaccess file and your cache manifest file.</p>
</blockquote>

<p>Step 2:
The easiest way I’ve found to accomplish this is to include a comment line with a revision number.
```
CACHE MANIFEST</p>

<h1 id="rev-43">rev 43</h1>

<p>clock.js
clock.css
```</p>

  </div>
  
    <ul class="tag_box inline">
      <li><i class="icon-folder-open"></i></li>
      
      


  
     
    	<li><a href="/categories.html#web-ref">
    		web <span>4</span>
    	</a></li>
    
  


    </ul>
    

  
    <ul class="tag_box inline">
      <li><i class="icon-tags"></i></li>
      
      


  
     
    	<li><a href="/tags.html#web-ref">web <span>5</span></a></li>
     
    	<li><a href="/tags.html#html5-ref">html5 <span>1</span></a></li>
    
  



    </ul>
  
  <hr>  
  <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/programming%20style/2015/06/03/JS-Best-Practices" title="Javascript Best Practices">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/programming%20style/2015/06/07/git-commit-style" title="Git commit style">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    
    var disqus_developer = 1;
    var disqus_shortname = 'lefttreegithubio'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
</div>



    </div>
      <!-- bootstrap -->
      <link href="/assets/themes/xiang/css/bootstrap.2.2.2.min.css" rel="stylesheet">
      <!-- syntax highlighting CSS -->
      <link rel="stylesheet" href="/assets/themes/xiang/css/syntax.css">

      <!-- Custom CSS -->
      <link rel="stylesheet" href="/assets/themes/xiang/css/main.css">

      <!-- Responsive CSS -->
      <link rel="stylesheet" href="/assets/themes/xiang/css/responsive.css">

      <!-- Google Fonts -->
      <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700' rel='stylesheet' type='text/css'>
      <link href='//fonts.googleapis.com/css?family=Raleway:300,400,700' rel='stylesheet' type='text/css'>
    <script src="/assets/themes/xiang/scripts/responsive.js" type="text/javascript"></script>
    



  </body>
</html>

